<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TRNG 3 Ngu·ªìn (Tr·∫°ng Th√°i M√†u S·∫Øc)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0fdf4; /* Light green background */
        }
        .container {
            min-height: 100vh;
        }
        .card {
            background-color: white;
            border: 2px solid #34d399; /* Emerald 400 border */
        }
        #timer-display {
            font-variant-numeric: tabular-nums;
            letter-spacing: 1px;
        }
        /* Hi·ªáu ·ª©ng nh·∫•p nh√°y khi ƒëang tr·ªôn */
        .mixing-active {
            animation: pulse-border 0.5s infinite alternate;
        }
        @keyframes pulse-border {
            from { border-color: #10b981; box-shadow: 0 0 8px rgba(16, 185, 129, 0.5); }
            to { border-color: #059669; box-shadow: 0 0 12px rgba(5, 150, 105, 0.7); }
        }
        .key-code {
            font-size: 0.65rem; 
        }
        #video-feed {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transform: scaleX(-1); /* L·∫≠t h√¨nh ·∫£nh (selfie view) */
        }
        .status-box {
            width: 80px;
            height: 64px;
            border-radius: 0.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
            border-width: 2px;
            
            /* Default: Inactive/Gray */
            border-color: #d1d5db; /* Gray 300 */
            background-color: #f3f4f6; /* Gray 100 */
        }
    </style>
</head>
<body>

<div class="container flex items-center justify-center p-4">
    <div class="card p-6 md:p-8 rounded-3xl shadow-2xl w-full max-w-sm">
        
        <h1 class="text-xl font-extrabold text-emerald-700 mb-2 text-center">üî¨ B·ªô Tr·ªôn Entropy 3 Ngu·ªìn</h1>
        <p class="text-xs text-gray-500 mb-4 text-center">Sensor + Mic + Camera ƒë·ªÉ t·∫°o Kh√≥a TRNG.</p>

        <!-- ƒê·ªìng h·ªì ƒë·∫øm ng∆∞·ª£c -->
        <div class="mb-4 text-center">
            <h2 class="text-lg font-semibold text-gray-700">Th·ªùi Gian C√≤n L·∫°i</h2>
            <p id="timer-display" class="text-5xl font-extrabold text-red-500 mt-1">5.00</p>
        </div>
        
        <!-- V√πng Ngu·ªìn Entropy (v·ªõi tr·∫°ng th√°i m√†u s·∫Øc) -->
        <div class="flex justify-around items-center mb-4">
            <!-- CAMERA STATUS -->
            <div id="video-container" class="status-box">
                <video id="video-feed" autoplay muted playsinline class="rounded-lg w-full h-full"></video>
            </div>
            <!-- MICROPHONE STATUS -->
            <div id="mic-status" class="status-box text-xs text-gray-600">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-400" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C10.9 2 10 2.9 10 4V10C10 11.1 10.9 12 12 12C13.1 12 14 11.1 14 10V4C14 2.9 13.1 2 12 2ZM17 11C17 13.76 14.76 16 12 16C9.24 16 7 13.76 7 11H5C5 14.41 7.79 17.2 11 17.77V21H13V17.77C16.21 17.2 19 14.41 19 11H17Z"/></svg>
            </div>
            <!-- SENSOR STATUS -->
            <div id="sensor-status-icon" class="status-box text-xs text-gray-600">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-400" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12C2 17.52 6.48 22 12 22C17.52 22 22 17.52 22 12C22 6.48 17.52 2 12 2ZM13 19H11V18H13V19ZM13 17H11V7H13V17Z"/></svg>
            </div>
        </div>

        <!-- N√∫t B·∫Øt ƒë·∫ßu -->
        <button id="start-button" class="w-full py-3 bg-emerald-600 text-white font-bold rounded-xl transition duration-200 hover:bg-emerald-700 shadow-lg shadow-emerald-300">
            B·∫Øt ƒë·∫ßu (C·∫ßn c·∫•p quy·ªÅn Camera & Mic)
        </button>

        <!-- K·∫øt qu·∫£ v√† ƒêi·ªÉm s·ªë -->
        <div class="mt-6 p-4 bg-gray-100 rounded-xl">
            <h2 class="text-base font-semibold text-gray-700 mb-3">üìä Ph√¢n T√≠ch ƒê√≥ng G√≥p Ngu·ªìn Ng·∫´u Nhi√™n</h2>

            <!-- Ngu·ªìn 1: Human Sensor -->
            <div class="flex justify-between items-center mb-2 p-3 bg-white rounded-lg border border-indigo-200 shadow-sm">
                <span class="text-sm font-medium text-indigo-700">1. Nhi·ªÖu V·∫≠t L√Ω (Sensor/B·∫°n):</span>
                <span id="human-score" class="text-xl font-extrabold text-indigo-600">--</span>
            </div>
            
            <!-- Metric 3: Hamming Distance (S·ª± tr·ªôn l·∫´n) -->
            <div class="flex justify-between items-center mb-4 p-2 bg-white rounded-lg border border-gray-200">
                <span class="text-sm font-medium text-gray-600">Kho·∫£ng C√°ch Hamming (ƒê·ªô ƒê·ªôc L·∫≠p):</span>
                <span id="hamming-distance" class="text-xl font-extrabold text-green-600">-- / 256</span>
            </div>
            
            <h3 class="text-sm font-bold text-gray-700 mb-1">üîë Kh√≥a C·ªßa B·∫°n (3 Ngu·ªìn + OS Mix)</h3>
            <code id="user-key" class="key-code block bg-white p-2 rounded-lg break-all font-mono text-gray-800 border min-h-[30px]">ƒêang ch·ªù...</code>
        </div>
        
    </div>
</div>

<script>
    // --- C·∫§U H√åNH ---
    const MAX_TIME_SECONDS = 5; 
    const MIXING_FACTOR = 100000; // ƒê·ªô ch√≠nh x√°c 5 s·ªë th·∫≠p ph√¢n
    const ENTROPY_LENGTH_BYTES = 32; // 256 bits

    // --- STATE V√Ä BI·∫æN GLOBAL ---
    let score = 0; 
    let mixCounter = 0;
    let isCollecting = false;
    let timerInterval = null;
    let audioContext = null;
    let analyserNode = null;
    let stream = null;
    let videoTimer = null;

    let entropyPool = new Uint32Array(ENTROPY_LENGTH_BYTES / 4); 
    let lastSensorValues = { alpha: 0, beta: 0, gamma: 0 };
    
    // --- DOM Elements ---
    const startButton = document.getElementById('start-button');
    const timerDisplay = document.getElementById('timer-display');
    const videoFeed = document.getElementById('video-feed');
    const videoContainer = document.getElementById('video-container');
    const micStatusIcon = document.getElementById('mic-status');
    const sensorStatusIcon = document.getElementById('sensor-status-icon');
    const userKey = document.getElementById('user-key');
    const humanScoreEl = document.getElementById('human-score'); 
    const hammingDistanceEl = document.getElementById('hamming-distance');
    
    // --- H√ÄM C·∫¨P NH·∫¨T TR·∫†NG TH√ÅI M√ÄU S·∫ÆC ---
    function setStatus(element, status) {
        // 0: Default/Inactive (Gray), 1: Active (Green), 2: Error (Red)
        element.classList.remove('border-gray-300', 'bg-gray-200', 'border-red-500', 'bg-red-100', 'border-emerald-500', 'bg-emerald-100');
        
        const svgIcon = element.querySelector('svg');
        if (svgIcon) svgIcon.classList.remove('text-gray-400', 'text-red-500', 'text-emerald-500');

        if (status === 1) { // ACTIVE
            element.classList.add('border-emerald-500', 'bg-emerald-100');
            if (svgIcon) svgIcon.classList.add('text-emerald-500');
        } else if (status === 2) { // ERROR
            element.classList.add('border-red-500', 'bg-red-100');
            if (svgIcon) svgIcon.classList.add('text-red-500');
        } else { // DEFAULT/INACTIVE
            element.classList.add('border-gray-300', 'bg-gray-200');
            if (svgIcon) svgIcon.classList.add('text-gray-400');
        }
    }


    // --- C√ÅC H√ÄM C√îNG C·ª§ M·∫¨T M√É H·ªåC ---
    
    function mixEntropy(newValue) {
        if (!isCollecting) return;
        const highPrecisionNoise = Math.floor(newValue * MIXING_FACTOR);
        const poolIndex = mixCounter % entropyPool.length;
        let existingValue = entropyPool[poolIndex];

        existingValue ^= highPrecisionNoise;

        const rotationAmount = (mixCounter % 32); 
        existingValue = (existingValue << rotationAmount) | (existingValue >>> (32 - rotationAmount));

        entropyPool[poolIndex] = existingValue;
        mixCounter++;
    }

    function bufferToHex(buffer) {
        return Array.from(new Uint8Array(buffer))
            .map(b => b.toString(16).padStart(2, '0'))
            .join('');
    }

    function calculateHammingDistance(arr1, arr2) {
        let distance = 0;
        const len = Math.min(arr1.length, arr2.length);
        for (let i = 0; i < len; i++) {
            let diff = arr1[i] ^ arr2[i]; 
            let count = 0;
            while (diff > 0) {
                diff &= (diff - 1);
                count++;
            }
            distance += count;
        }
        return distance;
    }

    // --- X·ª¨ L√ù SENSOR (Gia t·ªëc k·∫ø/Con quay) ---
    function handleDeviceOrientation(event) {
        if (!isCollecting) return;

        const alpha = event.alpha || 0;
        const beta = event.beta || 0;
        const gamma = event.gamma || 0;

        // Ch·ªâ thu th·∫≠p nhi·ªÖu khi gi√° tr·ªã thay ƒë·ªïi ƒë√°ng k·ªÉ
        const deltaAlpha = Math.abs(alpha - lastSensorValues.alpha);
        const deltaBeta = Math.abs(beta - lastSensorValues.beta);
        const deltaGamma = Math.abs(gamma - lastSensorValues.gamma);
        
        const totalDelta = deltaAlpha + deltaBeta + deltaGamma;
        
        if (totalDelta > 0.0001) { // L·ªçc nhi·ªÖu tƒ©nh
            score += totalDelta * MIXING_FACTOR; 
            mixEntropy(totalDelta);
            
            // Hi·ªáu ·ª©ng nh·∫•p nh√°y (ch·ªâ khi ƒëang tr·ªôn)
            sensorStatusIcon.classList.add('mixing-active');
            setTimeout(() => { sensorStatusIcon.classList.remove('mixing-active'); }, 50);

            lastSensorValues = { alpha, beta, gamma };
        }
    }
    
    // --- X·ª¨ L√ù MICRO ---
    function startMicEntropy(mediaStream) {
        if (!isCollecting) return;
        setStatus(micStatusIcon, 1); // ƒê·∫∑t tr·∫°ng th√°i Xanh L√°

        audioContext = new (window.AudioContext || window.webkitAudioContext)();
        analyserNode = audioContext.createAnalyser();
        analyserNode.fftSize = 256; 

        const source = audioContext.createMediaStreamSource(mediaStream);
        source.connect(analyserNode);

        const bufferLength = analyserNode.frequencyBinCount;
        const dataArray = new Uint8Array(bufferLength);

        const micLoop = () => {
            if (!isCollecting) return;
            analyserNode.getByteTimeDomainData(dataArray);

            let sumOfSquares = 0;
            for(let i = 0; i < bufferLength; i++) {
                // Nhi·ªÖu ƒëi·ªán t·ª≠: D√πng ƒë·ªô l·ªách trung b√¨nh (timing jitter)
                const value = dataArray[i] - 128;
                sumOfSquares += value * value;
            }
            const rms = Math.sqrt(sumOfSquares / bufferLength);

            mixEntropy(rms);
            micStatusIcon.classList.add('mixing-active');
            setTimeout(() => { micStatusIcon.classList.remove('mixing-active'); }, 50);

            requestAnimationFrame(micLoop);
        };
        micLoop();
    }

    // --- X·ª¨ L√ù CAMERA ---
    function startCameraEntropy(mediaStream) {
        if (!isCollecting) return;
        setStatus(videoContainer, 1); // ƒê·∫∑t tr·∫°ng th√°i Xanh L√°
        
        videoFeed.srcObject = mediaStream;
        
        const cameraLoop = () => {
             if (!isCollecting) return;
             
             // S·ª≠ d·ª•ng th·ªùi gian th·ª±c ƒë·ªÉ thu th·∫≠p nhi·ªÖu th·ªùi gian th·ª±c (Timing Jitter)
             const timeNoise = Date.now() % 10000;
             mixEntropy(timeNoise); 
             
             videoContainer.classList.add('mixing-active');
             setTimeout(() => { videoContainer.classList.remove('mixing-active'); }, 50);

             // L·∫•y nhi·ªÖu t·ª´ kho·∫£ng th·ªùi gian kh√¥ng c·ªë ƒë·ªãnh
             videoTimer = setTimeout(cameraLoop, Math.random() * 50 + 50); 
        };
        cameraLoop();
    }

    // --- QU·∫¢N L√ù TH·ªúI GIAN V√Ä TR·∫†NG TH√ÅI ---
    function startTimer() {
        let startTime = Date.now();
        let endTime = startTime + MAX_TIME_SECONDS * 1000;

        const updateTime = () => {
            const remainingTime = Math.max(0, endTime - Date.now());
            const seconds = (remainingTime / 1000).toFixed(2);
            timerDisplay.textContent = seconds;
            
            if (remainingTime > 0) {
                timerInterval = requestAnimationFrame(updateTime);
            } else {
                cancelAnimationFrame(timerInterval);
                stopCollection();
            }
        };
        timerInterval = requestAnimationFrame(updateTime);
    }
    
    function stopCollection() {
        isCollecting = false;
        
        // D·ª´ng Sensor
        window.removeEventListener('deviceorientation', handleDeviceOrientation);
        setStatus(sensorStatusIcon, 0); // Tr·ªü v·ªÅ tr·∫°ng th√°i m·∫∑c ƒë·ªãnh

        // D·ª´ng Mic/Camera
        if (stream) {
            stream.getTracks().forEach(track => track.stop());
        }
        if (audioContext) {
             audioContext.close();
        }
        if (videoTimer) {
             clearTimeout(videoTimer);
        }
        setStatus(micStatusIcon, 0); 
        setStatus(videoContainer, 0); 

        // T·∫°o Kh√≥a
        generateKeyAndScore();
        
        startButton.textContent = "B·∫Øt ƒë·∫ßu L·∫°i (5 Gi√¢y)";
        startButton.disabled = false;
        startButton.classList.add('bg-emerald-600', 'hover:bg-emerald-700');
        startButton.classList.remove('bg-gray-400', 'hover:bg-gray-500');
    }

    function generateKeyAndScore() {
        // ... (Logic t·∫°o kh√≥a v√† t√≠nh Hamming Distance gi·ªØ nguy√™n)
        // --- 1. Kh√≥a Tham Chi·∫øu (Reference Key - Ngu·ªìn OS TRNG) ---
        const referenceBytes = new Uint8Array(ENTROPY_LENGTH_BYTES);
        window.crypto.getRandomValues(referenceBytes);
        
        // --- 2. Kh√≥a C·ªßa B·∫°n (User Key - Tr·ªôn) ---
        const userBytes = new Uint8Array(ENTROPY_LENGTH_BYTES);
        userBytes.set(referenceBytes); 
        
        // Tr·ªôn (XOR) Pool Entropy t·ª´ 3 ngu·ªìn Sensor/Mic/Cam v√†o Kh√≥a Tham Chi·∫øu
        for (let i = 0; i < ENTROPY_LENGTH_BYTES; i++) {
            userBytes[i] ^= (entropyPool[Math.floor(i / 4)] >> ((i % 4) * 8)) & 0xFF;
        }

        const hexUserKey = bufferToHex(userBytes.buffer);
        userKey.textContent = hexUserKey.toUpperCase();

        // --- 3. T√≠nh Kho·∫£ng C√°ch Hamming ---
        const distance = calculateHammingDistance(userBytes, referenceBytes);

        // --- 4. Hi·ªÉn th·ªã K·∫øt qu·∫£ ---
        
        humanScoreEl.textContent = Math.round(score).toLocaleString('vi-VN');
        
        hammingDistanceEl.textContent = `${distance} / 256`; 

        let colorClass = 'text-green-600';
        if (distance < 115 || distance > 141) { colorClass = 'text-yellow-600'; } 
        if (distance < 100 || distance > 156) { colorClass = 'text-red-600'; }
        hammingDistanceEl.className = `text-xl font-extrabold ${colorClass}`;
    }

    // --- QU·∫¢N L√ù QUY·ªÄN V√Ä KH·ªûI T·∫†O ---
    async function getMediaPermissions() {
        try {
            // Y√™u c·∫ßu quy·ªÅn truy c·∫≠p Camera (m·∫∑t tr∆∞·ªõc) v√† Micro
            stream = await navigator.mediaDevices.getUserMedia({ 
                video: { facingMode: 'user', width: 100, height: 75 }, 
                audio: true 
            });
            startCameraEntropy(stream);
            startMicEntropy(stream.clone()); // S·ª≠ d·ª•ng clone stream cho mic ƒë·ªÉ ƒë·∫£m b·∫£o kh√¥ng b·ªã l·ªói khi d·ª´ng
            return true;
        } catch (error) {
            console.error("Kh√¥ng c·∫•p quy·ªÅn Camera/Mic:", error);
            setStatus(micStatusIcon, 2); // ƒê·ªè: L·ªói Mic
            setStatus(videoContainer, 2); // ƒê·ªè: L·ªói Camera
            alert("Vui l√≤ng cho ph√©p truy c·∫≠p Camera v√† Mic ƒë·ªÉ thu th·∫≠p Entropy t·ª´ 3 ngu·ªìn.");
            return false;
        }
    }

    async function startCollection() {
        // 1. Reset tr·∫°ng th√°i
        resetState();
        isCollecting = true;
        
        // 2. Xin quy·ªÅn Sensor (Ch·ªß y·∫øu cho iOS)
        let sensorPermissionGranted = false;
        if (typeof DeviceOrientationEvent.requestPermission === 'function') {
            try {
                const permission = await DeviceOrientationEvent.requestPermission();
                if (permission === 'granted') {
                    sensorPermissionGranted = true;
                } else {
                    setStatus(sensorStatusIcon, 2); // ƒê·ªè: L·ªói Sensor
                }
            } catch (error) {
                console.error("Sensor Permission Error:", error);
                setStatus(sensorStatusIcon, 2); // ƒê·ªè: L·ªói Sensor
            }
        } else {
            // C√°c tr√¨nh duy·ªát kh√¥ng c·∫ßn y√™u c·∫ßu (Android/C≈©)
            sensorPermissionGranted = true; 
        }

        if (sensorPermissionGranted) {
            setStatus(sensorStatusIcon, 1); // Xanh: Sensor Active
            window.addEventListener('deviceorientation', handleDeviceOrientation);
        }
        
        // 3. Xin quy·ªÅn Media (Camera/Mic)
        const mediaPermissionGranted = await getMediaPermissions();

        if (sensorPermissionGranted || mediaPermissionGranted) { // Ch·ªâ c·∫ßn √≠t nh·∫•t 1 ngu·ªìn ho·∫°t ƒë·ªông
            startButton.disabled = true;
            startButton.textContent = "ƒêANG THU TH·∫¨P...";
            startButton.classList.remove('bg-emerald-600', 'hover:bg-emerald-700');
            startButton.classList.add('bg-gray-400', 'hover:bg-gray-500');
            
            startTimer();
        } else {
            startButton.disabled = false;
            startButton.textContent = "‚ùå C·∫ßn C·∫•p Quy·ªÅn (Th·ª≠ l·∫°i)";
            isCollecting = false;
        }
    }

    function resetState() {
        score = 0;
        mixCounter = 0;
        isCollecting = false;
        entropyPool.fill(0); 
        lastSensorValues = { alpha: 0, beta: 0, gamma: 0 };
        
        timerDisplay.textContent = MAX_TIME_SECONDS.toFixed(2);
        humanScoreEl.textContent = "--";
        hammingDistanceEl.textContent = "-- / 256";
        userKey.textContent = "ƒêang ch·ªù...";

        hammingDistanceEl.className = `text-xl font-extrabold text-green-600`;
        setStatus(sensorStatusIcon, 0);
        setStatus(micStatusIcon, 0);
        setStatus(videoContainer, 0);
    }

    startButton.addEventListener('click', startCollection);
    
    resetState();
</script>

</body>
</html>

